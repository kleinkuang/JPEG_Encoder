# jpeg_encoder
Hardware Implementation of JPEG Encoder for Real-time Compression

# JPEG_Encoder
Develop Software &amp; Hardware JPEG Encoders for ISFET Images

The software implementation aims to realize the JPEG compression algorithm from the lowest level as it will be used for verifying the hardware implementation on FPGA.
It only requires `matplotlib` or `opencv-python` module to read the `.bmp` file and `numpy` for matrix operations.

## Python Implementation

### \# Result 
Encoded by Python Implmentation |  Encoded by FPGA
:-------------------------:|:-------------------------:
<img src="https://github.com/kleinkuang/jpeg_encoder/blob/main/python/demo/batman_3090_raw.bmp" width="512" height="512">  |  <img src="https://github.com/kleinkuang/jpeg_encoder/blob/main/python/demo/batman_3090_python.jpeg" width="512" height="512">

### \# Coding Details (e.g., MCU[10,10] from img_128x128.jpeg)
    img = plt.imread('./golden/MCUs/10_10.bmp', 0)

#### Input Image
    > ROW_LEN: 8  
    > COL_LEN: 8

#### DCT Matrix

    [[ 0.354  0.354  0.354  0.354  0.354  0.354  0.354  0.354]
     [ 0.49   0.416  0.278  0.098 -0.098 -0.278 -0.416 -0.49 ]  
     [ 0.462  0.191 -0.191 -0.462 -0.462 -0.191  0.191  0.462]  
     [ 0.416 -0.098 -0.49  -0.278  0.278  0.49   0.098 -0.416]  
     [ 0.354 -0.354 -0.354  0.354  0.354 -0.354 -0.354  0.354]  
     [ 0.278 -0.49   0.098  0.416 -0.416 -0.098  0.49  -0.278]  
     [ 0.191 -0.462  0.462 -0.191 -0.191  0.462 -0.462  0.191]  
     [ 0.098 -0.278  0.416 -0.49   0.49  -0.416  0.278 -0.098]]

#### MCU: (0, 0)
    [[44 42 38 42 45 41 48 39]
     [52 51 48 48 54 48 52 48]
     [25 26 22 26 26 28 29 24]
     [64 64 65 69 64 64 65 64]
     [64 64 64 64 65 64 57 64]
     [47 47 46 52 48 47 50 46]
     [36 47 46 46 41 44 37 38]
     [51 54 47 56 53 49 50 52]]

#### Level shift:
    [[ -84  -86  -90  -86  -83  -87  -80  -89]
     [ -76  -77  -80  -80  -74  -80  -76  -80]
     [-103 -102 -106 -102 -102 -100  -99 -104]
     [ -64  -64  -63  -59  -64  -64  -63  -64]
     [ -64  -64  -64  -64  -63  -64  -71  -64]
     [ -81  -81  -82  -76  -80  -81  -78  -82]
     [ -92  -81  -82  -82  -87  -84  -91  -90]
     [ -77  -74  -81  -72  -75  -79  -78  -76]]

#### FDCT:
    [[-636.375    1.773   -5.208    1.807    1.625    0.291   -6.367   -2.948]
     [ -19.891   -3.109    4.398    6.776   -0.415    2.942   -2.419    6.237]
     [ -34.805   -0.002    0.71     2.142   -0.282   -0.35    -5.378    1.348]
     [  16.405    1.011   -0.974    0.233   -0.464    0.675    0.925    1.79 ]
     [  56.375    0.28     1.605   -0.306    4.375    0.008    0.282   -0.125]
     [ -22.806   -0.176   -3.308   -2.391   -4.831    2.48     0.001   -2.525]
     [ -42.544   -4.465    2.372    3.316    1.605    4.486   -3.71    -0.538]
     [ -37.27     1.171   -0.859    0.593   -2.113   -4.338    3.073   -1.604]]

#### Quantized:
    [[-39.773   0.161  -0.521   0.113   0.068   0.007  -0.125  -0.048]
     [ -1.658  -0.259   0.314   0.357  -0.016   0.051  -0.04    0.113]
     [ -2.486  -0.      0.044   0.089  -0.007  -0.006  -0.078   0.024]
     [  1.172   0.059  -0.044   0.008  -0.009   0.008   0.012   0.029]
     [  3.132   0.013   0.043  -0.005   0.064   0.      0.003  -0.002]
     [ -0.95   -0.005  -0.06   -0.037  -0.06    0.024   0.     -0.027]
     [ -0.868  -0.07    0.03    0.038   0.016   0.037  -0.031  -0.005]
     [ -0.518   0.013  -0.009   0.006  -0.019  -0.043   0.03   -0.016]]

#### Round:
    [[-40.   0.  -1.   0.   0.   0.  -0.  -0.]
     [ -2.  -0.   0.   0.  -0.   0.  -0.   0.]
     [ -2.  -0.   0.   0.  -0.  -0.  -0.   0.]
     [  1.   0.  -0.   0.  -0.   0.   0.   0.]
     [  3.   0.   0.  -0.   0.   0.   0.  -0.]
     [ -1.  -0.  -0.  -0.  -0.   0.   0.  -0.]
     [ -1.  -0.   0.   0.   0.   0.  -0.  -0.]
     [ -1.   0.  -0.   0.  -0.  -0.   0.  -0.]]

#### Dequantized (Lossy):
    Check with the JPEGsnoop DCT Matrix
    [[-640.    0.  -10.    0.    0.    0.   -0.   -0.]
     [ -24.   -0.    0.    0.   -0.    0.   -0.    0.]
     [ -28.   -0.    0.    0.   -0.   -0.   -0.    0.]
     [  14.    0.   -0.    0.   -0.    0.    0.    0.]
     [  54.    0.    0.   -0.    0.    0.    0.   -0.]
     [ -24.   -0.   -0.   -0.   -0.    0.    0.   -0.]
     [ -49.   -0.    0.    0.    0.    0.   -0.   -0.]
     [ -72.    0.   -0.    0.   -0.   -0.    0.   -0.]]

### Zigzag:
    [[-40   0  -2  -2   0  -1   0   0]
     [  0   1   3   0   0   0   0   0]
     [  0   0   0   0  -1  -1   0   0]
     [  0   0   0   0   0   0   0   0]
     [  0   0   0  -1   0   0   0   0]
     [  0   0   0   0   0   0   0   0]
     [  0   0   0   0   0   0   0   0]
     [  0   0   0   0   0   0   0   0]]

#### RLE:
    - DC: -40
    - AC: [(1, -2), (0, -2), (1, -1), (3, 1), (0, 3), (9, -1), (0, -1), (13, -1), (0, 0)]

#### Encode DC
    > ZZ(0): -40
    > PRED : 0
    - SSSS : 6
    - DIFF : -40
    < SIZE : 1110
    < CODE : 010111

#### Huffman encoding:
    - DC: ((4, 14), (6, 23))
    - AC: [((5, 27), (2, 1)), ((2, 1), (2, 1)), ((4, 12), (1, 0)), ((6, 58), (1, 1)), ((2, 1), (2, 3)), ((9, 505), (1, 0)), ((2, 0), (1, 0)), ((11, 2040), (1, 0)), ((4, 10), (0, 0))]
    - DC: ['1110-010111']
    - AC: ['11011-01', '01-01', '1100-0', '111010-1', '01-11', '111111001-0', '00-0', '11111111000-0', '1010-']

#### Byte stream:
    E5 F6 AE 3A BF E4 3F C2 

#### Encoded data:
                           E5 F6 AE 3A BF E4 3F C2 
    BF

#### Hex data of .\Python\golden\MCUs\10_10.jpeg:
![](/Python/golden/MCUs/10_10_hex.png)

### \# Precision
The computed `.jpeg` image will not be exactly the same as the one encoded by matlab in most cases

E.g., for MCU[10,10]:  

The matrix after quantization (before round):

    # Quantized:
    [[19.914  0.711 -0.341 !0.498! 0.099  0.088 -0.001 -0.029]
     [10.284  0.037  0.552  0.432  0.11  -0.081  0.178 -0.018]
     [ 0.301  0.196 -0.413  0.196  0.005 -0.115  0.01  -0.022]
     [-0.668 -0.209  0.184  0.369 -0.102 -0.012 -0.08   0.053]
     [-2.993  0.215  0.056  0.158 -0.031 -0.019 -0.075 -0.043]
     [ 0.311  0.236 -0.019  0.079  0.008 -0.131 -0.017  0.023]
     [ 0.481  0.112 -0.02  -0.035  0.027 -0.087  0.026 -0.041]
     [-0.153  0.011 -0.077  0.077 -0.012 -0.113 -0.047  0.005]]
 
 The element 0.498 will be round to 0, but matlab computes it as 1 (due to precision when operating FDCT ?)

    # Round:
    [[20.  1. -0. !0.! 0.  0. -0. -0.]
     [10.  0.  1.  0.  0. -0.  0. -0.]
     [ 0.  0. -0.  0.  0. -0.  0. -0.]
     [-1. -0.  0.  0. -0. -0. -0.  0.]
     [-3.  0.  0.  0. -0. -0. -0. -0.]
     [ 0.  0. -0.  0.  0. -0. -0.  0.]
     [ 0.  0. -0. -0.  0. -0.  0. -0.]
     [-0.  0. -0.  0. -0. -0. -0.  0.]]

    # Dequantized (Lossy):
    Check with the JPEGsnoop DCT Matrix
    [[320.  11.  -0.  !0.!  0.   0.  -0.  -0.]
     [120.   0.  14.   0.   0.  -0.   0.  -0.]
     [  0.   0.  -0.   0.   0.  -0.   0.  -0.]
     [-14.  -0.   0.   0.  -0.  -0.  -0.   0.]
     [-54.   0.   0.   0.  -0.  -0.  -0.  -0.]
     [  0.   0.  -0.   0.   0.  -0.  -0.   0.]
     [  0.   0.  -0.  -0.   0.  -0.   0.  -0.]
     [ -0.   0.  -0.   0.  -0.  -0.  -0.   0.]]

This leads to a zero at (0, 3), compared to matlab coded one, it is 16.

Use JPEGSnoop to decode Python\golden\MCUs\6_6.jpeg:

    *** Decoding SCAN Data ***
    OFFSET: 0x00000148
    Scan Decode Mode: Full IDCT (AC + DC)

    Lum (Tbl #0), MCU=[0,0]
    [0x00000148.0]: ZRL=[ 0] Val=[   20] Coef=[00= DC] Data=[0x D4 37 5D 4E = 0b (11010100 -------- -------- --------)] 
    [0x00000149.0]: ZRL=[ 0] Val=[    1] Coef=[01..01] Data=[0x 37 5D 4E 12 = 0b (001----- -------- -------- --------)] 
    [0x00000149.3]: ZRL=[ 0] Val=[   10] Coef=[02..02] Data=[0x 37 5D 4E 12 = 0b (---10111 010----- -------- --------)] 
    Scan Data encountered marker   0xFFD9 @ 0x0000014E.0
    [0x0000014A.3]: ZRL=[ 3] Val=[    1] Coef=[03..06] Data=[0x 5D 4E 12 BF = 0b (---11101 01------ -------- --------)] 
    [0x0000014B.2]: ZRL=[ 0] Val=[    1] Coef=[07..07] Data=[0x 4E 12 BF FF = 0b (--001--- -------- -------- --------)] 
    [0x0000014B.5]: ZRL=[ 1] Val=[   -1] Coef=[08..09] Data=[0x 4E 12 BF FF = 0b (-----110 00------ -------- --------)] 
    [0x0000014C.2]: ZRL=[ 0] Val=[   -3] Coef=[10..10] Data=[0x 12 BF FF D9 = 0b (--0100-- -------- -------- --------)] 
    [0x0000014C.6]: ZRL=[ 0] Val=[    0] Coef=[11..11] Data=[0x 12 BF FF D9 = 0b (------10 10------ -------- --------)] EOB
                      DCT Matrix=[  320    11     0    !16!   0     0     0     0]
                                 [  120     0    14     0     0     0     0     0]
                                 [    0     0     0     0     0     0     0     0]
                                 [  -14     0     0     0     0     0     0     0]
                                 [  -54     0     0     0     0     0     0     0]
                                 [    0     0     0     0     0     0     0     0]
                                 [    0     0     0     0     0     0     0     0]
                                 [    0     0     0     0     0     0     0     0]

